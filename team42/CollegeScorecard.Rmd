---
title: "CollegeScorecard"
output: html_document
---

```{r}
require("doBy")
source("funcs.R")
require("tidyr")
require("ggplot2")
#make a symlink from the data dir in the directory where this file is to the desired data file
datafile <- "data/merged.csv"
```


```{r, cache=TRUE}
college.df <- read.csv(datafile, header = TRUE, na.strings = c("NULL"))
```

#### NA

What is the ratio of NAs to non-NAs overall? (Note that NA includes only "Null" - not "PrivacySuppressed".)
```{r, cache=TRUE}
na.columns <- is.na(college.df)
not.na.columns <- !is.na(college.df)

sum(na.columns)/sum(not.na.columns)
```


#### PrivacySuppressed

Now let's look at columns containing "PrivacySuppressed".

```{r, cache = TRUE}
# this leaves NA as NA (and not 1 or 0)
priv.supp.bool <- ifelse(college.df == "PrivacySuppressed", 1, 0)
not.priv.supp.bool <- ifelse(college.df == "PrivacySuppressed", 0, 1)

priv.supp.count <- sum(priv.supp.bool, na.rm = TRUE)
not.priv.supp.count <- sum(not.priv.supp.bool, na.rm = TRUE)
```

Here is the ratio of "privacy suppressed" elements to non-"privacy suppressed" elements. NAs are not included in either category.

```{r}
priv.supp.count/not.priv.supp.count
```


#### Column-wise analysis:

This includes NA counts and ratios, and "PrivacySuppressed" counts.

```{r}
col.na.ratios <- colSums(na.columns)/colSums(not.na.columns)
col.max.na <- c(max(col.na.ratios), nrow(college.df), which.max(col.na.ratios))
names(col.max.na) <- c("number of NAs", "number of rows", "column name")

col.na <- data.frame(na.count = colSums(na.columns),
                     row.count = nrow(college.df))
col.na$na.ratio <- with(col.na,na.count/(row.count - na.count))
col.na$na.fraction <- with(col.na,na.count/row.count)
col.na$priv.count <- colSums(priv.supp.bool, na.rm = TRUE)
col.na$priv.fraction <- with(col.na,priv.count/row.count)

col.na.most <- col.na[order(col.na$na.ratio,decreasing=TRUE),]
col.na.least <- col.na[order(col.na$na.ratio,decreasing=FALSE),]
col.priv.most <- col.na[order(col.na$priv.count,decreasing=TRUE),]
col.priv.least <- col.na[order(col.na$priv.count,decreasing=FALSE),]

head(col.na.most)
head(col.na.least)
head(col.priv.most)
```

Histogram of fractions of NAs:
```{r, echo=FALSE}
hist(col.na$na.fraction)
```

Histogram of fractions of PrivacySuppressed elements:
```{r, echo=FALSE}
hist(col.na$priv.fraction)
```

Ratio of columns with no privacy suppressed rows to those with privacy suppressed rows?
```{r}
sum(col.na$priv.count == 0)/sum(col.na$priv.count != 0)
```

Ratio of columns with no NA rows to those with NA rows?
```{r}
sum(col.na$na.count == 0)/sum(col.na$na.count != 0)
```


#### Looking forward.... this code is remarkably rough.

```{r}
head(
  summaryBy(
    FEMALE_COMP_ORIG_YR4_RT + FEMALE_COMP_ORIG_YR3_RT + FEMALE_COMP_ORIG_YR2_RT + FEMALE_COMP_ORIG_YR6_RT + FEMALE_COMP_ORIG_YR8_RT ~ region + PREDDEG, 
    data=college.df,
    FUN=function(x) {c(m =mean(x, na.rm = TRUE),s =sd(x, na.rm = TRUE)) }
    )
)
```

```{r}
c2 <- college.df
names(c2) <- rename_by_yaml(c2,"data/data_dictionary.yaml")

#c2 <- c2[,! grepl("school",names(c2)) & !grepl("location",names(c2))]
#kvs <- gather(c2,key=k,value=v,-X,-YEAR,-X.UNITID,-ope8_id,-ope6_id)
#kvs <- separate(kvs,k,into=c("p1","p2","p3"),sep=".",extra="merge")
```

#### Thoughts

What state pays its faculty the most?

```{r}
col.df <- read.csv(datafile, header = TRUE, na.strings = c("NULL", "PrivacySuppressed"))
```


```{r}
ggplot(college.df, aes(x = STABBR, y = AVGFACSAL)) + geom_boxplot() + xlab("State") + ylab("Avg monthly salary")
```

Percentage of full time faculty by state:

```{r}
ggplot(college.df, aes(x = STABBR, y = PFTFAC)) + geom_boxplot() + xlab("State") + ylab("Percentage full time faculty")
```

This looks like it should be the overall percentage of students making > 25k after 6,7,8,9 and 10 years, but these numbers look very wrong.

```{r}
colSums(col.df[,grep("^gt_25k*", colnames(col.df))], na.rm = TRUE)/nrow(col.df)
```

Should be the number of students that are working and not enrolled in various income brackets. Where are these numbers coming from?

```{r}
colSums(col.df[,grep("^count_wne_*", colnames(col.df))], na.rm = TRUE)
```

